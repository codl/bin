#!/bin/bash

function upload(){
    [[ "$DIR" == "" ]] && DIR="$(date +%y%m)"
    [[ "$DEST" == "" ]] && DEST=$(basename "$SOURCE" | tr " \\/()[]\"&'%" '_')

    URL="https://f.codl.fr/$DIR/$DEST"

    if [[ -e /bin/xclip ]]; then
        printf "$URL" | xclip -i -selection primary 2> /dev/null
        printf "$URL" | xclip -i -selection clipboard 2> /dev/null
    fi

    if [[ -d "$SOURCE" ]]; then
        rclone copyto -v --exclude=".git/" "$SOURCE" "s3:codl-public/$DIR/$DEST"
    else
        rclone copyto -v "$SOURCE" "s3:codl-public/$DIR/$DEST"
    fi

    if [[ $? == 0 ]]; then
        echo "$URL"
        notify-send uploaded
        exit 0
    fi
}

function usage(){
    echo "Usage : up [-temp] [-root] <file> [destination]" > /dev/stderr
    exit 1
}

while true; do
    case $1 in
        "")
            usage
            ;;
        "-temp"|"-tmp"|"-24")
            DIR="temp/$(date +%m%d)"
            shift
            ;;
        "-root")
            DIR="/"
            shift
            ;;
        *)
            if [[ "$SOURCE" == "" ]]; then
                SOURCE=$1
            elif [[ "$DEST" == "" ]]; then
                DEST=$1
            else
                echo "Error: Too many arguments" > /dev/stderr
                usage
            fi
            shift
            [[ "$1" == "" ]] && upload
    esac
done

